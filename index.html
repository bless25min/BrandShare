<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç•™è¨€åˆªé™¤åŠŸèƒ½èª¿è©¦å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: #f5f5f5;
        }
        
        .debug-panel {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .debug-title {
            color: #667eea;
            margin-bottom: 1rem;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .code-block {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            border-left: 4px solid #667eea;
            margin: 1rem 0;
        }
        
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .step {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .step-number {
            background: #2196f3;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 0.5rem;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin: 0.25rem;
        }
        
        button:hover {
            background: #5a6fd8;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ ç•™è¨€åˆªé™¤åŠŸèƒ½èª¿è©¦å·¥å…·</h1>
    
    <div class="debug-panel">
        <div class="debug-title">ğŸš¨ å¸¸è¦‹å•é¡Œè¨ºæ–·</div>
        
        <div class="warning">
            <strong>å¾æ‚¨çš„æˆªåœ–åˆ†æï¼Œå¯èƒ½çš„å•é¡Œï¼š</strong>
            <ul>
                <li>ç³»çµ±å¯èƒ½åœ¨æœ¬åœ°æ¨¡å¼é‹è¡Œï¼ˆè³‡æ–™ä¸æœƒæ°¸ä¹…ä¿å­˜ï¼‰</li>
                <li>Supabase RLS æ”¿ç­–å¯èƒ½è¨­å®šä¸æ­£ç¢º</li>
                <li>ç”¨æˆ¶æ¬Šé™é©—è­‰å¯èƒ½å¤±æ•—</li>
                <li>ç•™è¨€çš„ user_id å¯èƒ½èˆ‡ç•¶å‰ç”¨æˆ¶ä¸åŒ¹é…</li>
            </ul>
        </div>
    </div>

    <div class="debug-panel">
        <div class="debug-title">ğŸ› ï¸ ä¿®å¾©æ­¥é©Ÿ</div>
        
        <div class="step">
            <span class="step-number">1</span>
            <strong>æª¢æŸ¥ç³»çµ±æ¨¡å¼</strong>
            <div class="code-block">
// åœ¨ç€è¦½å™¨ Console ä¸­åŸ·è¡Œä»¥ä¸‹ä»£ç¢¼æª¢æŸ¥ï¼š
console.log('ç³»çµ±æ¨¡å¼:', supabaseClient ? 'è³‡æ–™åº«æ¨¡å¼' : 'æœ¬åœ°æ¨¡å¼');
console.log('ç•¶å‰ç”¨æˆ¶:', currentUser);
console.log('æ˜¯å¦ç‚ºç®¡ç†å“¡:', isAdmin);
            </div>
        </div>

        <div class="step">
            <span class="step-number">2</span>
            <strong>æª¢æŸ¥ Supabase RLS æ”¿ç­–</strong>
            <div class="code-block">
-- åœ¨ Supabase SQL Editor ä¸­åŸ·è¡Œï¼š
-- 1. æª¢æŸ¥ç¾æœ‰æ”¿ç­–
SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual 
FROM pg_policies 
WHERE tablename = 'comments';

-- 2. å¦‚æœæ²’æœ‰æ”¿ç­–ï¼Œå‰µå»ºå¿…è¦çš„æ”¿ç­–ï¼š
ALTER TABLE comments ENABLE ROW LEVEL SECURITY;

-- å…è¨±ç”¨æˆ¶åˆªé™¤è‡ªå·±çš„ç•™è¨€
CREATE POLICY "Users can delete own comments" 
ON comments FOR DELETE 
USING (auth.uid() = user_id);

-- å…è¨±ç”¨æˆ¶æ›´æ–°è‡ªå·±çš„ç•™è¨€
CREATE POLICY "Users can update own comments" 
ON comments FOR UPDATE 
USING (auth.uid() = user_id);

-- å…è¨±æ‰€æœ‰äººæŸ¥çœ‹ç•™è¨€
CREATE POLICY "Comments are viewable by everyone" 
ON comments FOR SELECT 
USING (true);

-- å…è¨±å·²ç™»å…¥ç”¨æˆ¶æ–°å¢ç•™è¨€
CREATE POLICY "Authenticated users can insert comments" 
ON comments FOR INSERT 
WITH CHECK (auth.uid() IS NOT NULL);
            </div>
        </div>

        <div class="step">
            <span class="step-number">3</span>
            <strong>æª¢æŸ¥ comments è¡¨çµæ§‹</strong>
            <div class="code-block">
-- ç¢ºä¿ comments è¡¨æœ‰æ­£ç¢ºçš„çµæ§‹ï¼š
CREATE TABLE IF NOT EXISTS comments (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    listing_id TEXT NOT NULL,
    author_name TEXT NOT NULL,
    author_email TEXT NOT NULL,
    content TEXT NOT NULL,
    parent_comment_id UUID REFERENCES comments(id) ON DELETE CASCADE,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    is_private BOOLEAN DEFAULT false,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- æª¢æŸ¥æ˜¯å¦ç¼ºå°‘ user_id æˆ– author_email æ¬„ä½
\d comments;
            </div>
        </div>

        <div class="step">
            <span class="step-number">4</span>
            <strong>ä¿®å¾©åˆªé™¤å‡½æ•¸</strong>
            <div class="code-block">
// æ›¿æ›åŸæœ‰çš„ deleteComment å‡½æ•¸ï¼š
async function deleteComment(commentId, isAdminDelete = false) {
    console.log('é–‹å§‹åˆªé™¤ç•™è¨€:', { commentId, isAdminDelete, currentUser: currentUser?.id });
    
    if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç•™è¨€å—ï¼Ÿ')) return;
    
    try {
        if (supabaseClient) {
            // å…ˆæª¢æŸ¥ç•™è¨€æ˜¯å¦å­˜åœ¨ä»¥åŠæ¬Šé™
            const { data: comment, error: fetchError } = await supabaseClient
                .from('comments')
                .select('*')
                .eq('id', commentId)
                .single();
            
            if (fetchError) {
                console.error('ç²å–ç•™è¨€å¤±æ•—:', fetchError);
                throw new Error('ç„¡æ³•æ‰¾åˆ°è©²ç•™è¨€');
            }
            
            console.log('ç•™è¨€è³‡æ–™:', comment);
            console.log('æ¬Šé™æª¢æŸ¥:', { 
                commentUserId: comment.user_id, 
                currentUserId: currentUser?.id,
                isMatch: comment.user_id === currentUser?.id,
                isAdmin: isAdmin 
            });
            
            // æ¬Šé™æª¢æŸ¥
            if (!isAdminDelete && comment.user_id !== currentUser?.id) {
                throw new Error('æ‚¨åªèƒ½åˆªé™¤è‡ªå·±çš„ç•™è¨€');
            }
            
            // åŸ·è¡Œåˆªé™¤
            const { error: deleteError } = await supabaseClient
                .from('comments')
                .delete()
                .eq('id', commentId);
            
            if (deleteError) {
                console.error('åˆªé™¤éŒ¯èª¤:', deleteError);
                throw deleteError;
            }
            
            console.log('åˆªé™¤æˆåŠŸ');
            showMessage(isAdminDelete ? 'ç®¡ç†å“¡åˆªé™¤ç•™è¨€æˆåŠŸï¼' : 'ç•™è¨€åˆªé™¤æˆåŠŸï¼');
            
            // é‡æ–°è¼‰å…¥ç•™è¨€
            const commentElement = document.querySelector(`[data-comment-id="${commentId}"]`);
            if (commentElement) {
                const listingCard = commentElement.closest('.listing-card');
                const listingId = listingCard?.querySelector('.comments-content')?.dataset?.listing;
                if (listingId) {
                    await loadComments(listingId);
                    updateCommentCount(listingId);
                }
            }
        } else {
            // æœ¬åœ°æ¨¡å¼ï¼šç›´æ¥ç§»é™¤ DOM å…ƒç´ 
            const commentElement = document.querySelector(`[data-comment-id="${commentId}"]`);
            if (commentElement) {
                commentElement.remove();
                showMessage('åˆªé™¤æˆåŠŸï¼ï¼ˆæœ¬åœ°æ¨¡å¼ï¼‰');
            }
        }
    } catch (error) {
        console.error('åˆªé™¤ç•™è¨€éŒ¯èª¤:', error);
        alert(`åˆªé™¤å¤±æ•—ï¼š${error.message || 'è«‹ç¨å¾Œå†è©¦'}`);
    }
}
            </div>
        </div>

        <div class="step">
            <span class="step-number">5</span>
            <strong>å¢å¼·æ¬Šé™æª¢æŸ¥</strong>
            <div class="code-block">
// åœ¨ displayComments å‡½æ•¸ä¸­å¢å¼·æ¬Šé™æª¢æŸ¥ï¼š
function displayComments(comments, listingId) {
    // ... å…¶ä»–ä»£ç¢¼ ...
    
    const mainComments = comments.filter(c => !c.parent_comment_id);
    const replyMap = {};
    
    comments.filter(c => c.parent_comment_id).forEach(reply => {
        if (!replyMap[reply.parent_comment_id]) {
            replyMap[reply.parent_comment_id] = [];
        }
        replyMap[reply.parent_comment_id].push(reply);
    });
    
    commentsList.innerHTML = mainComments.map(comment => {
        const isMyComment = currentUser && comment.user_id && (comment.user_id === currentUser.id);
        const replies = replyMap[comment.id] || [];
        const authorName = comment.users?.name || comment.author_name || 'åŒ¿åç”¨æˆ¶';
        
        // è©³ç´°çš„æ¬Šé™æª¢æŸ¥æ—¥èªŒ
        console.log('ç•™è¨€æ¬Šé™æª¢æŸ¥:', {
            commentId: comment.id,
            commentUserId: comment.user_id,
            currentUserId: currentUser?.id,
            isMyComment: isMyComment,
            isAdmin: isAdmin,
            canEdit: isMyComment,
            canDelete: isMyComment || isAdmin
        });
        
        return `
            <div class="comment" data-comment-id="${comment.id}">
                <div class="comment-header">
                    <span class="comment-author">
                        ${authorName}
                        ${isMyComment ? '<span class="comment-author-badge">æˆ‘</span>' : ''}
                    </span>
                    <div class="comment-meta">
                        <span class="comment-time">${formatDate(comment.created_at)}</span>
                    </div>
                </div>
                <div class="comment-content">${comment.content}</div>
                <div class="comment-actions">
                    ${currentUser && !isMyComment ? `
                        <button class="comment-action-btn" onclick="toggleReplyForm('${comment.id}')">
                            ğŸ’¬ å›è¦†
                        </button>
                    ` : ''}
                    ${currentUser && isMyComment ? `
                        <button class="comment-action-btn" onclick="editComment('${comment.id}')">
                            âœï¸ ç·¨è¼¯
                        </button>
                        <button class="comment-action-btn" onclick="deleteComment('${comment.id}', false)">
                            ğŸ—‘ï¸ åˆªé™¤
                        </button>
                    ` : ''}
                    ${currentUser && isAdmin && !isMyComment ? `
                        <button class="comment-action-btn admin-delete" onclick="deleteComment('${comment.id}', true)">
                            ğŸ›¡ï¸ ç®¡ç†å“¡åˆªé™¤
                        </button>
                    ` : ''}
                </div>
                <!-- å…¶ä»–å…§å®¹... -->
            </div>
        `;
    }).join('');
}
            </div>
        </div>
    </div>

    <div class="debug-panel">
        <div class="debug-title">ğŸ§ª å³æ™‚æ¸¬è©¦å·¥å…·</div>
        
        <div class="warning">
            <strong>åœ¨ç€è¦½å™¨ Console ä¸­åŸ·è¡Œä»¥ä¸‹ä»£ç¢¼é€²è¡Œæ¸¬è©¦ï¼š</strong>
        </div>
        
        <div class="code-block">
// 1. æª¢æŸ¥ç•¶å‰ç‹€æ…‹
console.log('=== ç³»çµ±ç‹€æ…‹æª¢æŸ¥ ===');
console.log('Supabase é€£æ¥:', !!supabaseClient);
console.log('ç•¶å‰ç”¨æˆ¶:', currentUser);
console.log('ç”¨æˆ¶ID:', currentUser?.id);
console.log('æ˜¯å¦ç®¡ç†å“¡:', isAdmin);
console.log('æ‰€æœ‰ç•™è¨€:', document.querySelectorAll('.comment').length);

// 2. æª¢æŸ¥ç•™è¨€æ¬Šé™
document.querySelectorAll('.comment').forEach((el, index) => {
    const commentId = el.dataset.commentId;
    console.log(`ç•™è¨€ ${index + 1}:`, {
        id: commentId,
        hasEditBtn: !!el.querySelector('.comment-action-btn[onclick*="editComment"]'),
        hasDeleteBtn: !!el.querySelector('.comment-action-btn[onclick*="deleteComment"]'),
        hasAdminDeleteBtn: !!el.querySelector('.admin-delete')
    });
});

// 3. æ¸¬è©¦åˆªé™¤åŠŸèƒ½ï¼ˆæ›¿æ›ç‚ºå¯¦éš›çš„ç•™è¨€IDï¼‰
// deleteComment('YOUR_COMMENT_ID_HERE', false);
        </div>
        
        <button onclick="navigator.clipboard.writeText(document.querySelector('.code-block:last-of-type').textContent)">
            ğŸ“‹ è¤‡è£½æ¸¬è©¦ä»£ç¢¼
        </button>
    </div>

    <div class="debug-panel">
        <div class="debug-title">âš¡ å¿«é€Ÿä¿®å¾©</div>
        
        <div class="success">
            <strong>å¦‚æœæ‚¨æƒ³è¦ç«‹å³ä¿®å¾©ï¼Œè«‹æŒ‰é †åºåŸ·è¡Œï¼š</strong>
            <ol>
                <li>åœ¨ Supabase SQL Editor ä¸­åŸ·è¡Œæ­¥é©Ÿ2çš„ SQL ä»£ç¢¼</li>
                <li>åœ¨ç€è¦½å™¨ Console ä¸­è²¼ä¸Šæ­¥é©Ÿ4çš„ä¿®å¾©å‡½æ•¸</li>
                <li>åˆ·æ–°é é¢ä¸¦é‡æ–°æ¸¬è©¦åˆªé™¤åŠŸèƒ½</li>
                <li>ä½¿ç”¨æ­¥é©Ÿ5çš„æ¸¬è©¦ä»£ç¢¼é€²è¡Œé©—è­‰</li>
            </ol>
        </div>
        
        <div class="error">
            <strong>å¦‚æœå•é¡Œä»ç„¶å­˜åœ¨ï¼š</strong>
            <ul>
                <li>æª¢æŸ¥ç€è¦½å™¨ Console æ˜¯å¦æœ‰éŒ¯èª¤è¨Šæ¯</li>
                <li>ç¢ºèªæ‚¨æœ‰æ¬Šé™å­˜å– Supabase å°ˆæ¡ˆ</li>
                <li>é©—è­‰ Google OAuth è¨­å®šæ˜¯å¦æ­£ç¢º</li>
                <li>æª¢æŸ¥ç¶²è·¯é€£æ¥æ˜¯å¦æ­£å¸¸</li>
            </ul>
        </div>
    </div>

    <div class="debug-panel">
        <div class="debug-title">ğŸ“ éœ€è¦é€²ä¸€æ­¥å”åŠ©ï¼Ÿ</div>
        <p>å¦‚æœä»¥ä¸Šæ­¥é©Ÿç„¡æ³•è§£æ±ºå•é¡Œï¼Œè«‹æä¾›ï¼š</p>
        <ul>
            <li>ç€è¦½å™¨ Console çš„å®Œæ•´éŒ¯èª¤è¨Šæ¯</li>
            <li>Supabase å°ˆæ¡ˆçš„ RLS æ”¿ç­–è¨­å®šæˆªåœ–</li>
            <li>comments è¡¨çš„çµæ§‹èªªæ˜</li>
            <li>æ¸¬è©¦ä»£ç¢¼çš„åŸ·è¡Œçµæœ</li>
        </ul>
    </div>

    <script>
        // æ·»åŠ ä¸€äº›å¯¦ç”¨çš„èª¿è©¦åŠŸèƒ½
        function showCurrentState() {
            const info = {
                hasSupabase: typeof supabaseClient !== 'undefined',
                hasCurrentUser: typeof currentUser !== 'undefined',
                isAdminStatus: typeof isAdmin !== 'undefined',
                commentCount: document.querySelectorAll('.comment').length
            };
            
            console.log('ç•¶å‰ç³»çµ±ç‹€æ…‹:', info);
            alert('ç³»çµ±ç‹€æ…‹å·²è¼¸å‡ºåˆ° Consoleï¼Œè«‹æŒ‰ F12 æŸ¥çœ‹');
        }
        
        // è‡ªå‹•æª¢æŸ¥å¸¸è¦‹å•é¡Œ
        window.addEventListener('load', function() {
            setTimeout(() => {
                if (typeof supabaseClient === 'undefined') {
                    console.warn('âš ï¸ æœªæª¢æ¸¬åˆ° supabaseClientï¼Œç³»çµ±å¯èƒ½åœ¨æœ¬åœ°æ¨¡å¼é‹è¡Œ');
                }
                
                if (typeof currentUser === 'undefined') {
                    console.warn('âš ï¸ æœªæª¢æ¸¬åˆ° currentUserï¼Œç”¨æˆ¶å¯èƒ½æœªç™»å…¥');
                }
                
                const comments = document.querySelectorAll('.comment');
                if (comments.length === 0) {
                    console.info('â„¹ï¸ ç•¶å‰é é¢æ²’æœ‰ç•™è¨€');
                } else {
                    console.info(`â„¹ï¸ æª¢æ¸¬åˆ° ${comments.length} æ¢ç•™è¨€`);
                }
            }, 1000);
        });
    </script>
</body>
</html>
