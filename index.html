<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>留言刪除功能調試工具</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: #f5f5f5;
        }
        
        .debug-panel {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .debug-title {
            color: #667eea;
            margin-bottom: 1rem;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .code-block {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            border-left: 4px solid #667eea;
            margin: 1rem 0;
        }
        
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .step {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .step-number {
            background: #2196f3;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 0.5rem;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin: 0.25rem;
        }
        
        button:hover {
            background: #5a6fd8;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <h1>🔧 留言刪除功能調試工具</h1>
    
    <div class="debug-panel">
        <div class="debug-title">🚨 常見問題診斷</div>
        
        <div class="warning">
            <strong>從您的截圖分析，可能的問題：</strong>
            <ul>
                <li>系統可能在本地模式運行（資料不會永久保存）</li>
                <li>Supabase RLS 政策可能設定不正確</li>
                <li>用戶權限驗證可能失敗</li>
                <li>留言的 user_id 可能與當前用戶不匹配</li>
            </ul>
        </div>
    </div>

    <div class="debug-panel">
        <div class="debug-title">🛠️ 修復步驟</div>
        
        <div class="step">
            <span class="step-number">1</span>
            <strong>檢查系統模式</strong>
            <div class="code-block">
// 在瀏覽器 Console 中執行以下代碼檢查：
console.log('系統模式:', supabaseClient ? '資料庫模式' : '本地模式');
console.log('當前用戶:', currentUser);
console.log('是否為管理員:', isAdmin);
            </div>
        </div>

        <div class="step">
            <span class="step-number">2</span>
            <strong>檢查 Supabase RLS 政策</strong>
            <div class="code-block">
-- 在 Supabase SQL Editor 中執行：
-- 1. 檢查現有政策
SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual 
FROM pg_policies 
WHERE tablename = 'comments';

-- 2. 如果沒有政策，創建必要的政策：
ALTER TABLE comments ENABLE ROW LEVEL SECURITY;

-- 允許用戶刪除自己的留言
CREATE POLICY "Users can delete own comments" 
ON comments FOR DELETE 
USING (auth.uid() = user_id);

-- 允許用戶更新自己的留言
CREATE POLICY "Users can update own comments" 
ON comments FOR UPDATE 
USING (auth.uid() = user_id);

-- 允許所有人查看留言
CREATE POLICY "Comments are viewable by everyone" 
ON comments FOR SELECT 
USING (true);

-- 允許已登入用戶新增留言
CREATE POLICY "Authenticated users can insert comments" 
ON comments FOR INSERT 
WITH CHECK (auth.uid() IS NOT NULL);
            </div>
        </div>

        <div class="step">
            <span class="step-number">3</span>
            <strong>檢查 comments 表結構</strong>
            <div class="code-block">
-- 確保 comments 表有正確的結構：
CREATE TABLE IF NOT EXISTS comments (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    listing_id TEXT NOT NULL,
    author_name TEXT NOT NULL,
    author_email TEXT NOT NULL,
    content TEXT NOT NULL,
    parent_comment_id UUID REFERENCES comments(id) ON DELETE CASCADE,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    is_private BOOLEAN DEFAULT false,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 檢查是否缺少 user_id 或 author_email 欄位
\d comments;
            </div>
        </div>

        <div class="step">
            <span class="step-number">4</span>
            <strong>修復刪除函數</strong>
            <div class="code-block">
// 替換原有的 deleteComment 函數：
async function deleteComment(commentId, isAdminDelete = false) {
    console.log('開始刪除留言:', { commentId, isAdminDelete, currentUser: currentUser?.id });
    
    if (!confirm('確定要刪除此留言嗎？')) return;
    
    try {
        if (supabaseClient) {
            // 先檢查留言是否存在以及權限
            const { data: comment, error: fetchError } = await supabaseClient
                .from('comments')
                .select('*')
                .eq('id', commentId)
                .single();
            
            if (fetchError) {
                console.error('獲取留言失敗:', fetchError);
                throw new Error('無法找到該留言');
            }
            
            console.log('留言資料:', comment);
            console.log('權限檢查:', { 
                commentUserId: comment.user_id, 
                currentUserId: currentUser?.id,
                isMatch: comment.user_id === currentUser?.id,
                isAdmin: isAdmin 
            });
            
            // 權限檢查
            if (!isAdminDelete && comment.user_id !== currentUser?.id) {
                throw new Error('您只能刪除自己的留言');
            }
            
            // 執行刪除
            const { error: deleteError } = await supabaseClient
                .from('comments')
                .delete()
                .eq('id', commentId);
            
            if (deleteError) {
                console.error('刪除錯誤:', deleteError);
                throw deleteError;
            }
            
            console.log('刪除成功');
            showMessage(isAdminDelete ? '管理員刪除留言成功！' : '留言刪除成功！');
            
            // 重新載入留言
            const commentElement = document.querySelector(`[data-comment-id="${commentId}"]`);
            if (commentElement) {
                const listingCard = commentElement.closest('.listing-card');
                const listingId = listingCard?.querySelector('.comments-content')?.dataset?.listing;
                if (listingId) {
                    await loadComments(listingId);
                    updateCommentCount(listingId);
                }
            }
        } else {
            // 本地模式：直接移除 DOM 元素
            const commentElement = document.querySelector(`[data-comment-id="${commentId}"]`);
            if (commentElement) {
                commentElement.remove();
                showMessage('刪除成功！（本地模式）');
            }
        }
    } catch (error) {
        console.error('刪除留言錯誤:', error);
        alert(`刪除失敗：${error.message || '請稍後再試'}`);
    }
}
            </div>
        </div>

        <div class="step">
            <span class="step-number">5</span>
            <strong>增強權限檢查</strong>
            <div class="code-block">
// 在 displayComments 函數中增強權限檢查：
function displayComments(comments, listingId) {
    // ... 其他代碼 ...
    
    const mainComments = comments.filter(c => !c.parent_comment_id);
    const replyMap = {};
    
    comments.filter(c => c.parent_comment_id).forEach(reply => {
        if (!replyMap[reply.parent_comment_id]) {
            replyMap[reply.parent_comment_id] = [];
        }
        replyMap[reply.parent_comment_id].push(reply);
    });
    
    commentsList.innerHTML = mainComments.map(comment => {
        const isMyComment = currentUser && comment.user_id && (comment.user_id === currentUser.id);
        const replies = replyMap[comment.id] || [];
        const authorName = comment.users?.name || comment.author_name || '匿名用戶';
        
        // 詳細的權限檢查日誌
        console.log('留言權限檢查:', {
            commentId: comment.id,
            commentUserId: comment.user_id,
            currentUserId: currentUser?.id,
            isMyComment: isMyComment,
            isAdmin: isAdmin,
            canEdit: isMyComment,
            canDelete: isMyComment || isAdmin
        });
        
        return `
            <div class="comment" data-comment-id="${comment.id}">
                <div class="comment-header">
                    <span class="comment-author">
                        ${authorName}
                        ${isMyComment ? '<span class="comment-author-badge">我</span>' : ''}
                    </span>
                    <div class="comment-meta">
                        <span class="comment-time">${formatDate(comment.created_at)}</span>
                    </div>
                </div>
                <div class="comment-content">${comment.content}</div>
                <div class="comment-actions">
                    ${currentUser && !isMyComment ? `
                        <button class="comment-action-btn" onclick="toggleReplyForm('${comment.id}')">
                            💬 回覆
                        </button>
                    ` : ''}
                    ${currentUser && isMyComment ? `
                        <button class="comment-action-btn" onclick="editComment('${comment.id}')">
                            ✏️ 編輯
                        </button>
                        <button class="comment-action-btn" onclick="deleteComment('${comment.id}', false)">
                            🗑️ 刪除
                        </button>
                    ` : ''}
                    ${currentUser && isAdmin && !isMyComment ? `
                        <button class="comment-action-btn admin-delete" onclick="deleteComment('${comment.id}', true)">
                            🛡️ 管理員刪除
                        </button>
                    ` : ''}
                </div>
                <!-- 其他內容... -->
            </div>
        `;
    }).join('');
}
            </div>
        </div>
    </div>

    <div class="debug-panel">
        <div class="debug-title">🧪 即時測試工具</div>
        
        <div class="warning">
            <strong>在瀏覽器 Console 中執行以下代碼進行測試：</strong>
        </div>
        
        <div class="code-block">
// 1. 檢查當前狀態
console.log('=== 系統狀態檢查 ===');
console.log('Supabase 連接:', !!supabaseClient);
console.log('當前用戶:', currentUser);
console.log('用戶ID:', currentUser?.id);
console.log('是否管理員:', isAdmin);
console.log('所有留言:', document.querySelectorAll('.comment').length);

// 2. 檢查留言權限
document.querySelectorAll('.comment').forEach((el, index) => {
    const commentId = el.dataset.commentId;
    console.log(`留言 ${index + 1}:`, {
        id: commentId,
        hasEditBtn: !!el.querySelector('.comment-action-btn[onclick*="editComment"]'),
        hasDeleteBtn: !!el.querySelector('.comment-action-btn[onclick*="deleteComment"]'),
        hasAdminDeleteBtn: !!el.querySelector('.admin-delete')
    });
});

// 3. 測試刪除功能（替換為實際的留言ID）
// deleteComment('YOUR_COMMENT_ID_HERE', false);
        </div>
        
        <button onclick="navigator.clipboard.writeText(document.querySelector('.code-block:last-of-type').textContent)">
            📋 複製測試代碼
        </button>
    </div>

    <div class="debug-panel">
        <div class="debug-title">⚡ 快速修復</div>
        
        <div class="success">
            <strong>如果您想要立即修復，請按順序執行：</strong>
            <ol>
                <li>在 Supabase SQL Editor 中執行步驟2的 SQL 代碼</li>
                <li>在瀏覽器 Console 中貼上步驟4的修復函數</li>
                <li>刷新頁面並重新測試刪除功能</li>
                <li>使用步驟5的測試代碼進行驗證</li>
            </ol>
        </div>
        
        <div class="error">
            <strong>如果問題仍然存在：</strong>
            <ul>
                <li>檢查瀏覽器 Console 是否有錯誤訊息</li>
                <li>確認您有權限存取 Supabase 專案</li>
                <li>驗證 Google OAuth 設定是否正確</li>
                <li>檢查網路連接是否正常</li>
            </ul>
        </div>
    </div>

    <div class="debug-panel">
        <div class="debug-title">📞 需要進一步協助？</div>
        <p>如果以上步驟無法解決問題，請提供：</p>
        <ul>
            <li>瀏覽器 Console 的完整錯誤訊息</li>
            <li>Supabase 專案的 RLS 政策設定截圖</li>
            <li>comments 表的結構說明</li>
            <li>測試代碼的執行結果</li>
        </ul>
    </div>

    <script>
        // 添加一些實用的調試功能
        function showCurrentState() {
            const info = {
                hasSupabase: typeof supabaseClient !== 'undefined',
                hasCurrentUser: typeof currentUser !== 'undefined',
                isAdminStatus: typeof isAdmin !== 'undefined',
                commentCount: document.querySelectorAll('.comment').length
            };
            
            console.log('當前系統狀態:', info);
            alert('系統狀態已輸出到 Console，請按 F12 查看');
        }
        
        // 自動檢查常見問題
        window.addEventListener('load', function() {
            setTimeout(() => {
                if (typeof supabaseClient === 'undefined') {
                    console.warn('⚠️ 未檢測到 supabaseClient，系統可能在本地模式運行');
                }
                
                if (typeof currentUser === 'undefined') {
                    console.warn('⚠️ 未檢測到 currentUser，用戶可能未登入');
                }
                
                const comments = document.querySelectorAll('.comment');
                if (comments.length === 0) {
                    console.info('ℹ️ 當前頁面沒有留言');
                } else {
                    console.info(`ℹ️ 檢測到 ${comments.length} 條留言`);
                }
            }, 1000);
        });
    </script>
</body>
</html>
