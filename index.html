-- 更新資料表結構，使用雜湊密碼
ALTER TABLE listings 
ADD COLUMN IF NOT EXISTS password_hash TEXT,
ADD COLUMN IF NOT EXISTS admin_managed BOOLEAN DEFAULT FALSE;

-- 建立管理員驗證函數
CREATE OR REPLACE FUNCTION verify_admin_password(input_password TEXT)
RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    admin_hash TEXT;
BEGIN
    -- 從 Supabase secrets 或配置表取得管理員密碼雜湊
    -- 這裡暫時使用硬編碼，實際應用時請使用 vault.secrets
    admin_hash := 'e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855'; -- 空字串的 SHA256，請更換為實際雜湊
    
    -- 計算輸入密碼的 SHA256 雜湊 (需要 pgcrypto 擴展)
    RETURN encode(digest(input_password, 'sha256'), 'hex') = admin_hash;
END;
$$;

-- 啟用 pgcrypto 擴展以支援雜湊功能
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- 建立密碼雜湊函數
CREATE OR REPLACE FUNCTION hash_password(password TEXT)
RETURNS TEXT
LANGUAGE plpgsql
AS $$
BEGIN
    RETURN encode(digest(password, 'sha256'), 'hex');
END;
$$;

-- 更新 RLS policies 以支援密碼驗證
DROP POLICY IF EXISTS "Enable read access for all users" ON listings;
DROP POLICY IF EXISTS "Enable insert access for all users" ON listings;
DROP POLICY IF EXISTS "Enable update access for all users" ON listings;
DROP POLICY IF EXISTS "Enable delete access for all users" ON listings;

-- 讀取權限：所有人都可以讀取
CREATE POLICY "Enable read access for all users" ON listings
FOR SELECT USING (true);

-- 插入權限：所有人都可以插入
CREATE POLICY "Enable insert access for all users" ON listings
FOR INSERT WITH CHECK (true);

-- 更新權限：只能更新自己的記錄（通過密碼驗證）
CREATE POLICY "Enable update with password verification" ON listings
FOR UPDATE USING (
    -- 允許管理員更新任何記錄
    verify_admin_password(current_setting('app.user_password', true)) OR
    -- 或者密碼雜湊匹配的記錄
    password_hash = hash_password(current_setting('app.user_password', true))
);

-- 刪除權限：只能刪除自己的記錄（通過密碼驗證）
CREATE POLICY "Enable delete with password verification" ON listings
FOR DELETE USING (
    -- 允許管理員刪除任何記錄
    verify_admin_password(current_setting('app.user_password', true)) OR
    -- 或者密碼雜湊匹配的記錄
    password_hash = hash_password(current_setting('app.user_password', true))
);

-- 確認 RLS 是啟用的
ALTER TABLE listings ENABLE ROW LEVEL SECURITY;
